import{s as K,n as G}from"../chunks/scheduler.DZs670Vv.js";import{S as M,i as J,e as f,s as O,c as u,a as P,k as F,f as R,d as y,l as _,m as Q,g as X,h as c,n as Y}from"../chunks/index.nE4-pPpD.js";const $="dab91435-b5a1-e29c-b041-bcd562613bde";var Z={GeneralPlusListen:"dab91382-b5a1-e29c-b041-bcd562613bde",GeneralPlusWrite:"dab91383-b5a1-e29c-b041-bcd562613bde",NordicListen:"dab90756-b5a1-e29c-b041-bcd562613bde",NordicWrite:"dab90757-b5a1-e29c-b041-bcd562613bde",RSSIListen:"dab90755-b5a1-e29c-b041-bcd562613bde",F2FListen:"dab91440-b5a1-e29c-b041-bcd562613bde",F2FWrite:"dab91441-b5a1-e29c-b041-bcd562613bde",FileWrite:"dab90758-b5a1-e29c-b041-bcd562613bde"},ee={1:"EndCurrentTransfer",2:"ReadyToReceive",3:"FileTransferTimeout",4:"ReadyToAppend",5:"FileReceivedOk",6:"FileReceivedErr"};const te=2,W=3;function B(e){let t={};for(let n in e){let i=e[n];t[i]=n}return t}let ne=B(Z);B(ee);let x,S=!1,ie={},g={},v=[],w=null,q=0,C=Symbol();function r(...e){let t=[];for(let i of e)DataView.prototype.isPrototypeOf(i)?t.push(I(i)):t.push(""+i);var n=t.join(" ");console.log(n)}function T(e){return new Promise(t=>setTimeout(t,e))}function I(e){return Array.prototype.map.call(new Uint8Array(e),t=>("00"+t.toString(16)).slice(-2)).join("")}function ae(){z(),S=!0}function j(){r("Device disconnected"),S=!1,w&&(clearInterval(w),w=null),j()}function re(e){let t=e.target.value;t.getUint8(0)!=34?r("Got GeneralPlus response",t):console.log(I(t));for(let n in v){let[i,a]=v[n];se(a,t)&&i(t)}}function le(e){}function se(e,t){if(typeof e>"u")return!0;for(let n=0;n<e.length;n++)if(t.getUint8(n)!=e[n])return!1;return!0}function H(e,t){let n=v.length;return v[n]=[t,e],n}function V(e){delete v[e]}function oe(e){let t=ge(e);console.log(t),document.getElementById("sensor-state")}async function ce(){let e=await U([114],[114]);r("dlc info: ",e);let t=e.getUint8(3)<<8|e.getUint8(4),n=e.getUint8(7)<<8|e.getUint8(8),i=[];for(let a=0;a<14;a++)i[a]=0,t&1<<a&&(i[a]=te),n&1<<a&&(i[a]=W);return i}async function de(e){let t=await U([115,e],[115,e]);var n={};if(n.len=t.getUint32(9)&16777215,n.len>0){let i=new DataView(t.buffer,2,8),a=new TextDecoder("utf-8");n.name=a.decode(i),n.checksum=t.getUint32(13),r(`slot ${e} name: ${n.name}, length: ${n.len} chksum: 0x`+n.checksum.toString(16))}else r(`slot ${e} is empty`);return n}async function fe(){let t=(await ce()).indexOf(W);return t==-1?null:await de(t)}async function ue(){let e=await fe();if(e){let t=e.name.replace(/^_+/,"")+".dlc".toUpperCase();r("current active slot is "+e.name+" looking for "+t);for(let n in ie)n.toUpperCase()==t&&r("setting up buttons for "+n)}}function ge(e){let t="";e.getUint8(1)&2&&(t="left"),e.getUint8(1)&1&&(t="right"),e.getUint8(2)==192?t="down":e.getUint8(2)&64?t="forward":e.getUint8(2)&128&&(t="back");let n="";e.getUint8(4)&1?n="upright":e.getUint8(4)&2?n="upside-down":e.getUint8(4)&4?n="lying on right side":e.getUint8(4)&8?n="lying on left side":e.getUint8(4)&32?n="leaning back":e.getUint8(4)&64?n="tilted right":e.getUint8(4)&128&&(n="tilted left");var i={};return i.antenna=t,i.orientation=n,e.getUint8(2)&1&&(i.tickle_head_back=!0),e.getUint8(2)&2&&(i.tickle_tummy=!0),e.getUint8(2)&4&&(i.tickle_right_side=!0),e.getUint8(2)&8&&(i.tickle_left_side=!0),e.getUint8(2)&16&&(i.pull_tail=!0),e.getUint8(2)&32&&(i.push_tongue=!0),i}function U(e,t){return new Promise((n,i)=>{e.length!=2&&e[0]!=32&&e[1]!=6&&r("Sending data to GeneralPlusWrite",I(e));var a;t!=C&&(a=H(t,s=>{V(a),n(s)})),q=performance.now(),g.GeneralPlusWrite.writeValue(new Uint8Array(e)).then(()=>{t==C&&n(null)}).catch(s=>{t!=C&&V(a),i(s)})})}function E(e,t,n){return r(`Setting antenna color to (${e}, ${t}, ${n})`),U([20,e,t,n],C)}function z(){w=setInterval(async()=>{if(performance.now()-q>3e3){let e=await U([32,6],[34]);r("Got ImHereSignal",e)}},1e3)}async function ve(){r("Requesting Bluetooth Devices with Furby name...");var e;try{x=await navigator.bluetooth.requestDevice({filters:[{name:"Furby"}],optionalServices:["generic_access","device_information",$]}),x.addEventListener("gattserverdisconnected",j),r("Connecting to GATT Server..."),e=await x.gatt.connect()}catch(a){alert("Failed to connect"),r(a.message);return}try{r("Getting Furby Service...");const a=await e.getPrimaryService($);r("Getting Furby Characteristics...");const s=await a.getCharacteristics();for(const l of s){var t=l.uuid,n=ne[t],i="";for(let h in l.properties)l.properties[h]&&(i+=h+" ");r("> Got Characteristic: "+t+" - "+n+" ("+i+")"),g[n]=l}g.GeneralPlusListen.addEventListener("characteristicvaluechanged",re),await g.GeneralPlusListen.startNotifications(),g.NordicListen.addEventListener("characteristicvaluechanged",le),await g.NordicListen.startNotifications()}catch(a){alert("Failed initialise BLE services"),r(a.message);return}v=[],z(),ae(),H([33],oe),await ue(),await E(255,0,0),await T(600),await E(0,255,0),await T(600),await E(0,0,255),await T(600)}function he(e){let t,n,i,a="Crazy furby!",s,l,h="Ben Glenn:",k,b,o,D="Connect",L,A;return{c(){t=f("div"),n=f("div"),i=f("h1"),i.textContent=a,s=O(),l=f("p"),l.textContent=h,k=O(),b=f("section"),o=f("button"),o.textContent=D,this.h()},l(m){t=u(m,"DIV",{class:!0});var p=P(t);n=u(p,"DIV",{class:!0});var d=P(n);i=u(d,"H1",{class:!0,"data-svelte-h":!0}),F(i)!=="svelte-p6kx9s"&&(i.textContent=a),s=R(d),l=u(d,"P",{"data-svelte-h":!0}),F(l)!=="svelte-nhnlnx"&&(l.textContent=h),k=R(d),b=u(d,"SECTION",{});var N=P(b);o=u(N,"BUTTON",{class:!0,style:!0,"data-svelte-h":!0}),F(o)!=="svelte-19qcrn4"&&(o.textContent=D),N.forEach(y),d.forEach(y),p.forEach(y),this.h()},h(){_(i,"class","h1"),_(o,"class","btn variant-filled-primary"),Q(o,"--opacity",S?.5:1),_(n,"class","space-y-5"),_(t,"class","container h-full mx-auto flex justify-center items-center")},m(m,p){X(m,t,p),c(t,n),c(n,i),c(n,s),c(n,l),c(n,k),c(n,b),c(b,o),L||(A=Y(o,"click",e[0]),L=!0)},p:G,i:G,o:G,d(m){m&&y(t),L=!1,A()}}}function be(e){function t(){S||(console.log("Attempting connect"),ve())}return[t]}class ye extends M{constructor(t){super(),J(this,t,be,he,K,{})}}export{ye as component};
